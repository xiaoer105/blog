---
title: "Http 短连接和长链接"
date: 2021-11-04T17:57:45+08:00
draft: false
toc: true
images:
tags: 
  - http
---

短连接和长连接在日常开发中经常听到，它们到底指的是什么呢，今天我们一起把它们弄清楚。

Http 底层使用 TCP/IP 进行通信，每次发送请求时都与服务器进行连接，服务器收到客户端发送的报文后进行响应回复并关闭连接。
## 短连接
客户端与服务器进行连接通信时，连接状态不会一直保持，当本次通信结束时，连接也就断开了，所以对于这种连接请求称为短连接。

### 短连接的缺点
简单介绍了短连接，现在来说说短连接的缺点。

在 TCP 协议里，每次建立连接和断开连接都是比较“昂贵”的操作。
TCP 建立连接需要进行三次握手，发送3个数据包，需要1.5个RTT（数据一来一回的时间），TCP 断开连接需要进行四次挥手，发送4个数据包，需要2个RTT。

如果是请求量比较大的情况下，每次请求都需要按照建立连接-发送请求-断开连接的顺序执行的话，对服务器存在很大的压力，光是频繁建立连接和断开连接都浪费大量的资源。

## 长连接

针对短连接的缺点，Http 协议提出长连接，长连接也叫持久连接（persistent connections）、连接保活（keep alive）、连接复用（connection reuse）。

在使用长连接的情况下，同时发送多个请求，在第一个请求建立连接后，其余的请求不在建立连接，而是复用第一个请求建立的连接，在最后一次请求时关闭连接即可。

由于长连接对性能有明显的效果改善，所以在 Http/1.1 中的连接默认都是使用长连接，不需要在头部中使用字段进行指定。
当然也可以使用 `Connection` 字段，值为 `keep-alive`，表示本次连接使用的是长连接。

### 长连接的缺点
长连接的缺点在于长时间连接不会关闭，服务器在内存中必须保存连接的状态，占用服务器的资源。
如果有大量的连接只连不发，那么服务器的资源很快就被耗尽。

所以，服务器需要设置超时时间和最大请求数，避免过多的长连接长时间占用连接资源。

### 长连接关闭策略
长连接关闭策略在客户端和服务端中都可以实现。

在客户端中，可以使用以下方式：
1. 在请求报文中增加 `Connectio: close` 字段，告诉服务器，这次请求通信结束后，就需要关闭连接。
2. 设置 keepalive_timeout 长连接超时时间，表示在一定时间内，没有发送数据，则关闭长连接。
3. 设置 keepalive_requests 长连接可发送最大请求数，表示客户端长连接发送的请求超过最大请求数时，则关闭连接。
4. 设置与服务器请求超时重试次数，当重试次数超过设置的阈值时，关闭连接

在服务器中，可以使用以下方式：
1. 设置 keepalive_timeout 长连接超时时间，在一定时间内，没有收到任何客户端发送的请求时，关闭连接。
2. 设置 keepalive_requests 长连接接收最大请求连接数，当服务器收到的连接数，超过设置的阈值时，关闭连接。
3. 设置接收客户端最大连接数，超过设置的连接数时，拒绝客户端的连接，不提供服务，或者使用限流策略等。

另外，客户端和服务器都可以在头部增加 `Keep-Alive: timeout=value` 字段，设置限定长连接的连接时间。但是这个约束能力并不强，需要通信都按照这个约束进行遵守才行。

## 怎么选择长连接和短连接
我们知道长连接和短连接的特性之后，应该怎么选择使用它们呢？其实也很简单，根据请求的频次来选择，对于一次性请求使用短连接，对于需要频繁与服务器通信的请求使用长连接。
